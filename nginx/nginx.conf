# server {
#     listen       80;
#     server_name  localhost;
    
#     # Статика фронтенда
#     location / {
#         root   /usr/share/nginx/html;
#         try_files $uri $uri/ /index.html;
#         index  index.html;
        
#         # Оптимизация для SPA
#         add_header Cache-Control "no-cache, no-store, must-revalidate";
#         add_header Pragma "no-cache";
#         add_header Expires "0";
#     }

#     # Healthcheck endpoint
#     location = /healthcheck {
#         proxy_pass http://backend:3000/healthcheck;
#         proxy_set_header Host $host;
#         add_header Cache-Control "no-store";
#         access_log off;
#     }

#     # API endpoints
#     location /api/afisha {
#         proxy_pass http://backend:3000/api/afisha;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_http_version 1.1;
#         proxy_set_header Connection "";
#         proxy_connect_timeout 60s;
#         proxy_read_timeout 60s;
#     }

#     # Статика бэкенда
#     location /content {
#         proxy_pass http://backend:3000;
#         proxy_set_header Host $host;
#         expires 1d;
#         access_log off;
#     }

#     # Обработка ошибок
#     error_page 500 502 503 504 /50x.html;
#     location = /50x.html {
#         root   /usr/share/nginx/html;
#         internal;
#     }
# }


#    server {
#     listen       80;
#     server_name  localhost;
    
#     # Статика фронтенда
#     location / {
#         root   /usr/share/nginx/html;
#         try_files $uri $uri/ /index.html;
#         index  index.html;
        
#         # Оптимизация для SPA
#         add_header Cache-Control "no-cache, no-store, must-revalidate";
#         add_header Pragma "no-cache";
#         add_header Expires "0";
#     }

#     # Healthcheck endpoint
#     location = /healthcheck {
#         proxy_pass http://backend:3000/healthcheck;
#         proxy_set_header Host $host;
#         add_header Cache-Control "no-store";
#         access_log off;
#     }

#     # API endpoints
#     location /api/afisha {
#         proxy_pass http://backend:3000/api/afisha;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_http_version 1.1;
#         proxy_set_header Connection "";
#         proxy_connect_timeout 60s;
#         proxy_read_timeout 60s;
#     }

#     # Статика бэкенда
#     location /content {
#         proxy_pass http://backend:3000;
#         proxy_set_header Host $host;
#         expires 1d;
#         access_log off;
#     }

#     # Обработка ошибок
#     error_page 500 502 503 504 /50x.html;
#     location = /50x.html {
#         root   /usr/share/nginx/html;
#         internal;
#     }
# } 
   
    # server {
    # listen       80;
    # server_name  localhost;
    
    # # Статика фронтенда
    # location / {
    #     root   /usr/share/nginx/html;
    #     try_files $uri $uri/ /index.html;
    #     index  index.html;
        
    #     # Оптимизация для SPA
    #     add_header Cache-Control "no-cache, no-store, must-revalidate";
    #     add_header Pragma "no-cache";
    #     add_header Expires "0";
    # }

    # # API endpoints
    # location /api {
    #     proxy_pass http://backend:3000;
        
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
        
    #     proxy_http_version 1.1;
    #     proxy_set_header Connection "";
        
    #     # Таймауты
    #     proxy_connect_timeout 60s;
    #     proxy_read_timeout 60s;
    # }

    # # Статика бэкенда
    # location /content {
    #     proxy_pass http://backend:3000;
    #     proxy_set_header Host $host;
        
    #     # Кеширование статики
    #     expires 1d;
    #     access_log off;
    # }

    # # Обработка ошибок
    # error_page 500 502 503 504 /50x.html;
    # location = /50x.html {
    #     root   /usr/share/nginx/html;
    #     internal;
    # }
# }
    
    
    server {
        listen       80;
        server_name  localhost;
        
        # Статика фронтенда
        location / {
            root   /usr/share/nginx/html;
            try_files $uri $uri/ /index.html;
            index  index.html;
                        
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }

        # API endpoints
        location /api {
            rewrite ^/api/(.*)$ /api/afisha/$1 break;
            proxy_pass http://backend:3000;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Таймауты
            proxy_connect_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Healthcheck endpoint
        location = /healthcheck {
            proxy_pass http://backend:3000/api/afisha/healthcheck;
            proxy_set_header Host $host;
            
            # Быстрый ответ без кеширования
            add_header Cache-Control "no-store";
            access_log off;
        }

        # Статика бэкенда
        location /content {
            proxy_pass http://backend:3000;
            proxy_set_header Host $host;
            
            # Кеширование статики
            expires 1d;
            access_log off;
        }

        # Обработка ошибок
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
            internal;
        }
    }
